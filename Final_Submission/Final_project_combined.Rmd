### Predicting flight delay probability and delay time
contributed by Danyao Jin, Shannon Ma, Xinyi Li and Zifan Wang


We used a collected data from 5.7 million flights from January 2017 to December 2017 from the website of the BTS [website](https://www.transtats.bts.gov/DL_SelectFields.asp?Table_ID=236). The data is made available in monthly files, with the option to select the fields for download. The specific data set used in this analysis can be found [here](https://drive.google.com/drive/folders/1vdqOY_xefMxKq_pz8pJeUulraGcnn-iU?usp=sharing).


## Overview and motivation:
Flight delay remains to be a huge problem for travelers worldwide. A delay of flight is often defined as arriving or departing more than 15 minutes later than schedule. According to the U.S. Department of Transportation (DOT) Bureau of Transportation Statistics (BTS), 18.15% of all scheduled flights are delayed in U.S. in 2017. Some main causes of delay include late arrival of the last flight, National Aviation System delay (congested airports and air-traffic-jam), and airline¡¯s reasons. [1](https://www.transtats.bts.gov/OT_Delay/OT_DelayCause1.asp?pn=1)

As a traveler, what can I do to avoid flight delay or minimize delay time? Which airline performs the best? Does travelling in a busy Monday increase my chance of suffering delay? 
Which time of a day might reduce the delay time? Do those big airports like John F. Kennedy International airport have the highest delay rates? Do main causes of delay vary according to airlines and airports?

In this project, we used the data of U.S. domestic flight in 2017 from Bureau of Transportation Statistics to explore factors influencing flight delay rate and delay time, construct regression model for delay prediction, and come up advices for choosing a best plan for a given route.

## Initial questions:
Which factors influence the probability of flight delay and delay time? Some factors we considered as important and available from the database were airlines, day of week, time of day, airports, regions and routes. To how much extent do they influence the probability of flight delay and delay time? During the process, we noticed that the impact of weekday and daytime might vary according to airlines. We also conducted analyses stratified on airlines.

## Related work:
The predicting flight delay project of Ian Cassidy [2](https://engineering.upside.com/applying-predictive-analytics-to-flight-delays-85413ca4939f) gave us advice about data source. The delay predictor application based on their model was very interesting, and inspired us to do something interactive to present our results.

## Part 0: Description of the data
The U.S. Department of Transportation (DOT) Bureau of Transportation Statistics (BTS) collected detailed information of carrier on-time performance, including each flight information, delay time, and delay reason. We downloaded the dataset from their website [3](https://www.transtats.bts.gov/DL_SelectFields.asp?Table_ID=236). We confined our research question to the latest year (2017) since a larger database could not be run on our computers.



```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(dplyr)
library(dslabs)
library(readr)
library(ggthemes)
library(RColorBrewer)
library(shiny)
library(plotly)
library(splitstackshape)
library(lsmeans)
library(rsconnect)
```

```{r message=FALSE, warning=FALSE}
#read in dataset "flight2017.csv"
dat <- read_csv("C:/Users/jindanyao/Desktop/2018fall/2018fall/BST260/final project/database/flight2017.csv") 
```

# Data cleaning (checking distributions and missing values)

```{r}
# check missing values:
colSums(is.na(dat))
```
There are no missings for the year, quarter, month, day of month, day of weak, date, origin or destination city/states of the flights. There are 80,343 missing values for departure delay times, the main outcome of interest in our study. We assume that the missing values are due to flight cancellation. For this study, we will look at the flights with non-missing departure delay times (missing values will be automatically excluded from the plots or regression models. 


We also look at the distributions of the relevant variables
```{r}
summary(dat)
```


The minimum departure delay time is 0 (in this dataset, all early departures are set to 0), and the maximum departure delay time is 2755 minutes (i.e. 46 hours). After We checked on [TripAdvisor](https://www.tripadvisor.com/ShowTopic-g609057-i12143-k4639347-What_s_your_longest_ever_flight_delay-Ovacik_Oludeniz_Mugla_Province_Turkish_Aegean_Coast.html) and [The Ten Worst Flight Delays In History](https://jalopnik.com/the-ten-worst-flight-delays-in-history-1530577136), we believe that the maximum value of departure delay times in this dataset could be reasonable, so we won't exclude it. Also, to make sure that we won't be impacted by potential extreme values, we will not only perform linear regressions but also logistic regressions in our data analysis.

The minimum flight distance is 31 miles, and the longest flight distance is 4983 miles, which are also reasonable (see [shortest US flight route from Barnstaple Municipal Airport on Cape Cod to Nantucket Memorial Airport](http://edition.cnn.com/travel/article/world-shortest-air-routes/index.html) and [~ 4000 miles distance from New York to Hawaii](https://www.distancefromto.net/distance-from-new-york-to-hawaii).

```{r}
month_freq <- table(dat$MONTH)
day_freq <- table(dat$DAY_OF_WEEK)
carrier_freq <- table(dat$OP_UNIQUE_CARRIER)
state <- table(dat$ORIGIN_STATE_ABR)

month_freq <- as.data.frame(month_freq)
day_freq <- as.data.frame(day_freq)
carrier_freq <- as.table(carrier_freq)
state <- as.table(state)

month_freq
day_freq
carrier_freq
state

```
The frequencies of month, day of week, carrier, and departure state of the flights are all in reasonable range as well.




The dataset is pretty clean, with very few missing values or extreme values. In this project, we excluded all cancelled flights and diverted flights. Delayed flight is delayed for 15 minutes or above.

## Part 1: Exploratory analysis
# Influence of airlines:
First, we looked at the delay percentage across 12 airlines in U.S.:
```{r echo=FALSE}
#delay percentage
flight_perc <- dat%>%
  filter(!is.na(DEP_DEL15)) %>%
  group_by(OP_UNIQUE_CARRIER)%>%
  mutate(percent_delay = sum(DEP_DEL15)/length(DEP_DEL15))%>%
  select(OP_UNIQUE_CARRIER,percent_delay)%>%
  unique()%>%
  ggplot(aes(x=reorder(OP_UNIQUE_CARRIER,percent_delay),y=percent_delay))+
  geom_bar(stat ="identity" )+
  geom_text(mapping = aes(label=signif(percent_delay,2)), hjust = 0)+
  coord_flip()+
  ggtitle("Percentage of delays in different airlines")+
  theme_economist()+
  scale_fill_economist()+
  guides(fill=guide_legend(title=NULL))+
  xlab("")+
  ylab("percetage")
flight_perc
```

The percentage of delays for most airlines is in the range of 15% to 25%. `JetBlue` has the highest delay of 27% and `Hawaiian Airlines` has the lowest flight delay of only 8.4%. 

We continue to investigate the average time of delays (among delayed flights) and reasons.
```{r echo=FALSE}
#delay time and reason
flight_avg2 <- dat%>%
  filter(!is.na(DEP_DELAY_NEW)) %>%
  filter(DEP_DELAY_NEW>=15)%>%
  group_by(OP_UNIQUE_CARRIER)%>%
  filter(!is.na(CARRIER_DELAY)) %>%
  mutate(carrier_cause=mean(CARRIER_DELAY))%>%
  filter(!is.na(WEATHER_DELAY)) %>%
  mutate(weather_cause=mean(WEATHER_DELAY))%>%
  filter(!is.na(NAS_DELAY)) %>%
  mutate(NAS_cause=mean(NAS_DELAY))%>%
  filter(!is.na(SECURITY_DELAY)) %>%
  mutate(security_cause=mean(SECURITY_DELAY))%>%
  filter(!is.na(LATE_AIRCRAFT_DELAY)) %>%
  mutate(late_cause=mean(LATE_AIRCRAFT_DELAY))%>%
  select(OP_UNIQUE_CARRIER,carrier_cause,NAS_cause,weather_cause,security_cause,late_cause)%>%
  unique()%>%
  gather(type,value,-OP_UNIQUE_CARRIER)%>%
  ggplot(aes(x=reorder(OP_UNIQUE_CARRIER,value),value,fill=type))+
  geom_bar(stat="identity",position="stack")+
  geom_col(aes(fill = type), position = position_stack(reverse = TRUE))+
  ggtitle("Average minutes of delays in different airlines")+
  theme_economist()+
  scale_fill_economist()+
  guides(fill=guide_legend(title=NULL))+
  coord_flip()+
  xlab("")+
  ylab("minutes")
flight_avg2
```

Among flights with delays, you have to wait for 60-80 minutes for most airlines. `ExpressJet` and `SkyWest` tend to have longest waiting time of more than 80 minutes. `Hawaiian Airlines` and `Southwest Airlines` tends to have shortest time of 50-minute delays. 

For the delay reasons, *Carrier Delay* and *Late Arrival Delay* is the two main reasons of delay for most airlines. Look, delays due to Weather problems are not as frequent as we we expect! 
(Carrier: delay due to carrier reasons, such as aircraft cleaning, fueling, maintenance, awaiting the arrival of connecting passengers and baggage. 
Late: delay due to the late arrival of the same aircraft at previous airport.
NAS: Delay due to National Airspace System, such as non-extreme weather condition, heavy traffic volume and air traffic control. 
Security: Delay caused by evacuation of a terminal or concourse. 
Weather: Delay caused by extreme weather.)


# Influence of departure time:
What time of the day are you most likely to be delayed?
```{r}
dat0 <- dat %>% select(CRS_DEP_TIME, OP_UNIQUE_CARRIER, DEP_DEL15, DAY_OF_WEEK, DEP_DELAY_NEW)
```

Generate departure hour:
```{r}
dat1 <- dat0 %>% mutate(DEP_HOUR=as.integer(as.numeric(CRS_DEP_TIME)/100))
```

Generate overall delay percentage, overall average delay hours, and delay percentage and average delay hours for each carrier (dat2 for percentage, dat3 for delay hour-only delayed flight included):
```{r}
dat2<- dat1 %>%  filter(!is.na(DEP_DEL15)) %>%
  group_by(DEP_HOUR, DAY_OF_WEEK) %>%
  mutate(PERCENTAGE_OVERALL=mean(DEP_DEL15))
dat3<- dat1 %>% filter(!is.na(DEP_DELAY_NEW) & DEP_DEL15==1) %>%
  group_by(DEP_HOUR) %>%
  mutate(AVERAGE_OVERALL=mean(DEP_DELAY_NEW))

dat4 <- dat2 %>%  filter(!is.na(DEP_DEL15)) %>%
  group_by(OP_UNIQUE_CARRIER, DAY_OF_WEEK, DEP_HOUR) %>%
  mutate(PERCENTAGE=mean(DEP_DEL15))
dat5 <- dat3 %>% filter(!is.na(DEP_DELAY_NEW) & DEP_DEL15==1) %>%
  group_by(OP_UNIQUE_CARRIER,DEP_HOUR) %>%
  mutate(AVERAGE=mean(DEP_DELAY_NEW))

dat6 <- dat1 %>% filter(!is.na(DEP_DELAY_NEW) & DEP_DEL15==1) %>%
  group_by(DAY_OF_WEEK,DEP_HOUR) %>%
  mutate(AVERAGE_NEW=mean(DEP_DELAY_NEW))
```

Heatmap for overall delay percentage:
```{r}
dat2 %>% ggplot(aes(DEP_HOUR, DAY_OF_WEEK,  fill = PERCENTAGE_OVERALL)) +
  geom_tile(color = "white") +
  scale_fill_gradientn(colors = brewer.pal(9, "Reds"),limits=c(0,1)) +
  scale_y_continuous(breaks=seq(1,7))+
  theme_minimal() +  
  theme(panel.grid = element_blank()) +
  labs(title="Overall delay percentage in each hour and each day of week",y="Day of week",x="Departure hour")
```

Overall, `2-4am` is the time period with the highest delay rate (about 25%). On the contrary, `5-10am` is the period with the lowest delay rate (about 10%). Departing in the morning might minimize your probability of encountering flight delay. Delay rate is higher on *Thursday, Friday, Sunday and Monday* than other days.

Heatmap for overall delay time:
```{r}
dat6 %>% ggplot(aes(DEP_HOUR, DAY_OF_WEEK,  fill = AVERAGE_NEW)) +
  geom_tile(color = "white") +
  scale_fill_gradientn(colors = brewer.pal(9, "Reds")) +
  scale_y_continuous(breaks=seq(1,7))+
  theme_minimal() +  
  theme(panel.grid = element_blank()) +
  labs(title="Overall delay time (minutes) in each hour and each day of week",y="Day of week",x="Departure hour")
```

Delay time is among the highest during at 1-6am and on Friday, Sunday and Monday.

Bar plot for overall average delay hours:
```{r}
dat3 %>% select(DEP_HOUR,AVERAGE_OVERALL) %>%
  unique() %>%
  ggplot(aes(DEP_HOUR,AVERAGE_OVERALL))+
  geom_bar(stat="identity", fill="#720017")+
  labs(title="Overall delay time (minutes) in each hour and each day of week",y="Average delay time",x="Departure hour")
```

`1-2am` and `5-8am` have relatively high delay time on avergae. According to the plot, the worst choice might be having your flight schedule at 5am, which may leading to average delay time for nearly 90 minutes.

We also designed an application to show your delay probability and delay time on average when you choose your airline and departure hour.
```{r eval=FALSE, include=FALSE}
runApp("C:/Users/jindanyao/Desktop/2018fall/2018fall/BST260/final project/database/app.R")
```

From the plot above, we can see that the effect of departure hour and departure day on delay rate do not vary across different airlines. The general trend is the delay rate is higher on Thursday, Friday, Sunday and Monday than other days. And the delay rate is especially high during 0 to 4am, while 5 to 10am seems to be the safest time period to avoid flight delay. Overall, Hawaiian Airlines performs the best in terms of delay rate, while JetBlue Airlines performs the worst among all 12 carriers in the database. Interstingly, if you choose to take a flight by Spirit Airlines leaving in Saturday 3am, or by United Airlines leaving in Thursday or Friday 4am, or by SkyWest Airlines leaving in 0am during Thursday to Saturday, you are going to suffer a flight delay almost 100% time.

The effect of departure hour on average delay time seems to differ among different airlines. SkyWest Airlines has astonishingly high delay time. Imagine you have a flight by SkyWest sheduled to departing at 0am, you often need to wait more than 1.5 hour for your SkyWest flight. Hawaiian Airlines has the best performance on delay time as most of flight delay time is below 1 hour.


# Influence of seasons:
```{r}
Sys.setenv("plotly_username"="ziwang970")
Sys.setenv("plotly_api_key"="Rh542AcijT2qJ07JZsQY")
```

```{r}
Sys.setenv("plotly_username"="tsma29")
Sys.setenv("plotly_api_key"="7VWfMILchgTnOAX2DiZA")
```

```{r}
# calculate mean departure delay minutes by state and by Seasons
state_delay_spring <- dat %>%  filter(DEP_DEL15==1) %>% filter(MONTH %in% c(3,4,5))%>%
  group_by(ORIGIN_STATE_ABR) %>%
  summarize(mean_delay = mean(DEP_DELAY_NEW, na.rm = TRUE))

state_delay_summer <- dat %>% filter(DEP_DEL15==1) %>% filter(MONTH %in% c(6,7,8))%>%
  group_by(ORIGIN_STATE_ABR) %>%
  summarize(mean_delay = mean(DEP_DELAY_NEW, na.rm = TRUE))

state_delay_autumn <- dat %>% filter(DEP_DEL15==1) %>% filter(MONTH %in% c(9,10,11))%>%
  group_by(ORIGIN_STATE_ABR) %>%
  summarize(mean_delay = mean(DEP_DELAY_NEW, na.rm = TRUE))

state_delay_winter <- dat %>% filter(DEP_DEL15==1) %>% filter(MONTH %in% c(12,1,2))%>%
  group_by(ORIGIN_STATE_ABR) %>%
  summarize(mean_delay = mean(DEP_DELAY_NEW, na.rm = TRUE))
```

```{r}
# give state boundaries white borders
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

# make the plot
p_spring <- plot_geo(state_delay_spring, locationmode = 'USA-states') %>%
  add_trace(
    z = ~mean_delay, locations = ~ORIGIN_STATE_ABR,
    color = ~mean_delay, colors = 'Reds'
  ) %>%
  colorbar(title = "Departure delay(min) in spring") %>%
  layout(
    title = '2017 average departure delay (minutes) by states in Spring',
    geo = g
  )

p_summer <- plot_geo(state_delay_summer, locationmode = 'USA-states') %>%
  add_trace(
    z = ~mean_delay, locations = ~ORIGIN_STATE_ABR,
    color = ~mean_delay, colors = 'Reds'
  ) %>%
  colorbar(title = "Departure delay(min) in summer") %>%
  layout(
    title = '2017 average departure delay (minutes) by states in Summer',
    geo = g
  )

p_autumn <- plot_geo(state_delay_autumn, locationmode = 'USA-states') %>%
  add_trace(
    z = ~mean_delay, locations = ~ORIGIN_STATE_ABR,
    color = ~mean_delay, colors = 'Reds'
  ) %>%
  colorbar(title = "Departure delay(min) in autumn") %>%
  layout(
    title = '2017 average departure delay (minutes) by states in Autumn',
    geo = g
  )

p_winter <- plot_geo(state_delay_winter, locationmode = 'USA-states') %>%
  add_trace(
    z = ~mean_delay, locations = ~ORIGIN_STATE_ABR,
    color = ~mean_delay, colors = 'Reds'
  ) %>%
  colorbar(title = "Departure delay(min) in winter") %>%
  layout(
    title = '2017 average departure delay (minutes) by states in Winter',
    geo = g
  )
```


```{r}
p_season <- subplot(p_spring, p_summer, p_autumn, p_winter, nrows = 2) %>%
  layout(title = "2017 average departure delay (minutes) by seasons",
         xaxis = list(domain=list(x=c(0,0.5),y=c(0,0.5))),
         scene = list(domain=list(x=c(0.5,1),y=c(0,0.5))),
         xaxis2 = list(domain=list(x=c(0.5,1),y=c(0.5,1))),
         annotations = list(
 list(x = 0.2 , y = 1, text = "spring", showarrow = F, xref='paper', yref='paper'),
  list(x = 0.8 , y = 1, text = "summer", showarrow = F, xref='paper', yref='paper'),
 list(x = 0.2 , y = 0.5, text = "autumn", showarrow = F, xref='paper', yref='paper'),
  list(x = 0.8 , y = 0.5, text = "winter", showarrow = F, xref='paper', yref='paper'))
         )
p_season
```

Also, seasonal changes can affect flight delay and we want to get an overall view of how delay times are distributed across different regions in four seasons. We can see the states of longest delay time varies across season. Delays are shorter during *Fall* and longer during *Spring and Summer*. You can point to each state to check the average delay time in each season.


# Influence of airports:
Which Airports tends to experience more delays?
Location is another important factor that can affect flight delay. We are curious about whether flight delays differ significantly among different airports, no matter for weather reasons or heavy traffic volume reasons. Hence, we choose the top 10 busiest airports in US for analysis [4](https://www.world-airport-codes.com/us-top-40-airports.html). 

```{r echo=FALSE}
#delay percentage
airport_perc <- dat%>%
  filter(ORIGIN %in% c("JFK","MIA","LAX","EWR","ORD","ATL","SFO","IAH","IAD","DFW"))%>%
  filter(!is.na(DEP_DEL15)) %>%
  group_by(ORIGIN)%>%
  mutate(percent_delay = sum(DEP_DEL15)/length(DEP_DEL15))%>%
  select(ORIGIN,percent_delay)%>%
  unique()%>%
  ggplot(aes(x=reorder(ORIGIN,percent_delay),y=percent_delay))+
  geom_bar(stat ="identity" )+
   geom_text(mapping = aes(label=signif(percent_delay,2)), hjust = 0)+
  coord_flip()+
  ggtitle("Percentage of delays in top 10 busiest airports")+
  theme_economist()+
  scale_fill_economist()+
  guides(fill=guide_legend(title=NULL))+
  xlab("")+
  ylab("percentage")
airport_perc
```

Among the top 10 busiest airport in US, the percentage of delays is in the range of 15% to 25%. *Newark Liberty International Airport* has the highest delay of 25%. *George Bush Intercontinental Airport* and *Washington Dulles International Airport* has the lowest flight delays of 15%. 

```{r echo=FALSE}
#delay time
airport_avg2 <- dat%>%
  filter(ORIGIN %in% c("JFK","MIA","LAX","EWR","ORD","ATL","SFO","IAH","IAD","DFW"))%>%
  filter(!is.na(DEP_DELAY_NEW)) %>%
  filter(DEP_DELAY_NEW>=15)%>%
  group_by(ORIGIN)%>%
  filter(!is.na(CARRIER_DELAY)) %>%
  mutate(carrier_cause=mean(CARRIER_DELAY))%>%
  filter(!is.na(WEATHER_DELAY)) %>%
  mutate(weather_cause=mean(WEATHER_DELAY))%>%
  filter(!is.na(NAS_DELAY)) %>%
  mutate(NAS_cause=mean(NAS_DELAY))%>%
  filter(!is.na(SECURITY_DELAY)) %>%
  mutate(security_cause=mean(SECURITY_DELAY))%>%
  filter(!is.na(LATE_AIRCRAFT_DELAY)) %>%
  mutate(late_cause=mean(LATE_AIRCRAFT_DELAY))%>%
  select(ORIGIN,carrier_cause,NAS_cause,weather_cause,security_cause,late_cause)%>%
  unique()%>%
  gather(type,value,-ORIGIN)%>%
  ggplot(aes(x=reorder(ORIGIN,value),value,fill=type))+
  geom_bar(stat="identity",position="stack")+
  geom_col(aes(fill = type), position = position_stack(reverse = TRUE))+
  ggtitle("Average minutes of delays in top 10 busiest airports")+
  theme_economist()+
  scale_fill_economist()+
  guides(fill=guide_legend(title=NULL))+
  coord_flip()+
  xlab("")+
  ylab("minutes")
airport_avg2
```

If the flight delays, you have to wait for 60-80 minutes for most airports. Although *Washington Dulles International Airport* has the lowest percentage of flight delays, it has longest average minutes of delays of more than 90 minutes. John F. Kennedy International Airport ranks second for 88 minutes of average delays. *Los Angeles International Airport* has the lowest average waiting time of 66 minutes. 


# Influence of geographical factors:
Here, we look into more details about the effect of geographical factors on the flight delays. We will use interactive maps to describe the delay patterns in different US states, cities, and by different flight routes.

In this step, we will describe the average delay times of each `state`:

```{r}
# calculate mean departure delay minutes by state
state_delay <- dat %>% filter(DEP_DEL15==1) %>%
  group_by(ORIGIN_STATE_ABR) %>%
  summarize(mean_delay = mean(DEP_DELAY_NEW, na.rm = TRUE))
```

```{r}
# give state boundaries white borders
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

# make the plot
p_state <- plot_geo(state_delay, locationmode = 'USA-states') %>%
  add_trace(
    z = ~mean_delay, locations = ~ORIGIN_STATE_ABR,
    color = ~mean_delay, colors = 'Purples'
  ) %>%
  colorbar(title = "Departure delay in minutes") %>%
  layout(
    title = '2017 average departure delay (minutes) by states',
    geo = g
  )
p_state
```

From the plot, we see that in general, the `Northeast` region of the US had experienced longer delay times in 2017 (States like Maine or Vermont had average delay times over 20 minutes). For other regions, there seems to be relatively long delay times in the South and the West coast.


We then look at the delay time patterns for each departure `city`: 
The delay times are categorized into 4 quartiles and shown by colored bubbles, and the size of the bubbles depicts the length of delay time:
```{r}
# calculate mean departure delay minutes by city
city_delay <- dat %>% filter(DEP_DEL15==1) %>%
  group_by(ORIGIN_CITY_NAME) %>%
  summarize(mean_delay = mean(DEP_DELAY_NEW, na.rm = TRUE))

city_delay <- cSplit(city_delay, "ORIGIN_CITY_NAME", sep=",")

city_delay <- city_delay %>% mutate(name = ORIGIN_CITY_NAME_1)
```

```{r}
# add the coordination of cities
coordinate <- read.csv('https://raw.githubusercontent.com/plotly/datasets/master/2014_us_cities.csv')


city_delay <- city_delay %>% mutate(name = trimws(as.character(name)))

coordinate <- coordinate %>% mutate(name = trimws(as.character(name)))

merged_city_delay <- left_join(city_delay,coordinate, by='name')

merged_city_delay <- merged_city_delay %>% 
  group_by(name) %>%
  summarize(mean_delay = mean(mean_delay, na.rm = TRUE), lat = mean(lat), lon = mean(lon))

```

```{r}
# draw the plot by cities
merged_city_delay$q <- with(merged_city_delay, cut(mean_delay, quantile(mean_delay)))
levels(merged_city_delay$q) <- paste(c("1st", "2nd", "3rd", "4th", "5th"), "Quantile")
merged_city_delay$q <- as.ordered((merged_city_delay$q))


g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showland = TRUE,
  landcolor = toRGB("gray85"),
  subunitwidth = 1,
  countrywidth = 1,
  subunitcolor = toRGB("white"),
  countrycolor = toRGB("white")
)

p_cities <- plot_geo(merged_city_delay, locationmode = 'USA-states', sizes = c(1, 250)) %>%
  add_markers(
    x = ~lon, y = ~lat, size = ~mean_delay, color = ~q, hoverinfo = "text",
    text = ~paste(merged_city_delay$name, "<br />", merged_city_delay$mean_delay, "minutes")
  ) %>%
  layout(title = '2017 average departure delay (minutes) by city', geo = g)
p_cities
```

From the plot, we see that similar to the plot by states, cities in the `Northeast, South and the West coast` are more likely to have delay times at the highest (yellow) or second highest (green) quartiles, with some cities (e.g. St. Augustine in Florida) reaching average delays of more than 60 minutes. Cities with the shortest average delay times are generally in the `Midwest` area.


Next, we look at the `flight routes` with delays: 
we will display the routes with an average delay time of 15+, 30+, 60+, and 90+ minutes in 2017:
```{r}
# group by flight routes and calculate mean departure delay

route_delay <- dat %>% filter(DEP_DEL15==1) %>%
  group_by(ORIGIN_CITY_NAME, DEST_CITY_NAME) %>%
  summarize(mean_delay = mean(DEP_DELAY_NEW, na.rm = TRUE)) 


route_delay <- cSplit(route_delay, "ORIGIN_CITY_NAME", sep=",")
route_delay <- cSplit(route_delay, "DEST_CITY_NAME", sep=",")

route_delay <- route_delay %>% mutate(name1 = ORIGIN_CITY_NAME_1, name2 = DEST_CITY_NAME_1)
```

```{r}
# add the coordination of cities
coordinate <- read.csv('https://raw.githubusercontent.com/plotly/datasets/master/2014_us_cities.csv')

route_delay <- route_delay %>% mutate(name1 = trimws(as.character(name1)), name2 = trimws(as.character(name2)))

coordinate <- coordinate %>% mutate(name = trimws(as.character(name)))


merged_1 <- left_join(route_delay,coordinate, by = c("name1" = "name")) %>%
  rename(lat1 = lat, lon1 = lon, pop1 = pop) %>%
  select(mean_delay, name1, name2, pop1, lat1, lon1)

merged_2 <- left_join(route_delay,coordinate, by = c("name2" = "name")) %>%
  rename(lat2 = lat, lon2 = lon, pop2 = pop) %>%
  select(mean_delay, name1, name2, pop2, lat2, lon2)

merged_route_delay <- left_join(merged_1, merged_2, by = c("name1", "name2")) %>%
  rename(mean_delay = mean_delay.x) %>%
  select(mean_delay, name1, name2, pop1, lat1, lon1, pop2, lat2, lon2)

merged_route_delay <- merged_route_delay %>%      # get the mean population for each city
  group_by(name1, name2) %>%
  summarize(mean_delay = mean(mean_delay, na.rm = TRUE), 
            pop1 = mean(pop1, na.rm = TRUE), pop2 = mean(pop2, na.rm = TRUE),
            lat1 = mean(lat1, na.rm = TRUE), lon1 = mean(lon1, na.rm = TRUE),
            lat2 = mean(lat2, na.rm = TRUE), lon2 = mean(lon2, na.rm = TRUE))
```

```{r}
# map projection

# restrict to >15, >30, >60, >90 minutes of delay
delay1 <-merged_route_delay %>%
  filter(mean_delay >= 60) 
delay2 <-merged_route_delay %>%
  filter(mean_delay >= 120) 
delay3 <-merged_route_delay %>%
  filter(mean_delay >= 180) 
delay4 <-merged_route_delay %>%
  filter(mean_delay >= 240) %>% filter(!is.na(pop1)) %>% filter(!is.na(pop2)) 

geo <- list(
  scope = 'north america',
  projection = list(type = 'azimuthal equal area'),
  showland = TRUE,
  landcolor = toRGB("gray95"),
  countrycolor = toRGB("gray80")
)


p1 <- plot_geo(locationmode = 'USA-states', color = I("red")) %>%
  add_markers(
    data = delay1, x = ~lon1, y = ~lat1, text = ~name1,
    size = ~pop1, hoverinfo = "text", alpha = 0.5
  ) %>%
  add_markers(
    data = delay1, x = ~lon2, y = ~lat2, text = ~name2,
    size = ~pop2, hoverinfo = "text", alpha = 0.5
  ) %>%
  add_segments(
    x = ~lon1, xend = ~lon2,
    y = ~lat1, yend = ~lat2,
    alpha = 0.3, size = I(1), hoverinfo = "none"
  ) %>%
  layout(
    title = '2017 flight routes with >60 min delay',
    geo = geo, showlegend = FALSE) 



p2 <- plot_geo(locationmode = 'USA-states', color = I("red")) %>%
  add_markers(
    data = delay1, x = ~lon1, y = ~lat1, text = ~name1,
    size = ~pop1, hoverinfo = "text", alpha = 0.5
  ) %>%
  add_markers(
    data = delay2, x = ~lon2, y = ~lat2, text = ~name2,
    size = ~pop2, hoverinfo = "text", alpha = 0.5
  ) %>%
  add_segments(
    x = ~lon1, xend = ~lon2,
    y = ~lat1, yend = ~lat2,
    alpha = 0.3, size = I(1), hoverinfo = "none"
  ) %>%
  layout(
    title = '2017 flight routes with >120 min delay',
    geo = geo, showlegend = FALSE)



p3 <- plot_geo(locationmode = 'USA-states', color = I("red")) %>%
  add_markers(
    data = delay3, x = ~lon1, y = ~lat1, text = ~name1,
    size = ~pop1, hoverinfo = "text", alpha = 0.5
  ) %>%
  add_markers(
    data = delay3, x = ~lon2, y = ~lat2, text = ~name2,
    size = ~pop2, hoverinfo = "text", alpha = 0.5
  ) %>%
  add_segments(
    x = ~lon1, xend = ~lon2,
    y = ~lat1, yend = ~lat2,
    alpha = 0.3, size = I(1), hoverinfo = "none"
  ) %>%
  layout(
    title = '2017 flight routes with >180 min delay',
    geo = geo, showlegend = FALSE )


p4 <- plot_geo(locationmode = 'USA-states', color = I("red")) %>%
  add_markers(
    data = delay3, x = ~lon1, y = ~lat1, text = ~name1,
    size = ~pop1, hoverinfo = "text", alpha = 0.5
  ) %>%
  add_markers(
    data = delay4, x = ~lon2, y = ~lat2, text = ~name2,
    size = ~pop2, hoverinfo = "text", alpha = 0.5
  ) %>%
  add_segments(
    x = ~lon1, xend = ~lon2,
    y = ~lat1, yend = ~lat2,
    alpha = 0.3, size = I(1), hoverinfo = "none"
  ) %>%
  layout(
    title = '2017 flight routes with >240 min delay',
    geo = geo, showlegend = FALSE )
```


```{r}
p <- subplot(p1, p2, p3, p4, nrows = 2) %>%
  layout(title = "2017 flight routes with different delay times",
         xaxis = list(domain=list(x=c(0,0.5),y=c(0,0.5))),
         scene = list(domain=list(x=c(0.5,1),y=c(0,0.5))),
         xaxis2 = list(domain=list(x=c(0.5,1),y=c(0.5,1))),
         annotations = list(
 list(x = 0.2 , y = 1, text = ">60 mins", showarrow = F, xref='paper', yref='paper'),
  list(x = 0.8 , y = 1, text = ">120 mins", showarrow = F, xref='paper', yref='paper'),
 list(x = 0.2 , y = 0.5, text = ">180 mins", showarrow = F, xref='paper', yref='paper'),
  list(x = 0.8 , y = 0.5, text = ">240 mins", showarrow = F, xref='paper', yref='paper'))
         )
p
```

We can see from the plot that as the threshold for delays increases, the number of routes with the corresponding delay time decreases. There have been many routes with average delay times of 15+ minutes in 2017, but only very few of them had an average delay of more than 60 or 90 minutes (e.g. the route between New York and San Antonio).


## Part 3: Regression models

After gaining an overview of the delay patterns by various factors, we wish to make predictions of delay times. We will be using linear regression models to predict mean delay times, and logistic regression models to predict the probablity of delay (>= 15 minutes).

# Predict mean delay time for each carrier / day of week / time of day using linear model

In this part, we are using linear models to predict mean delay times. Our predictors of interest are *carrier*, *days of week* and *time of day*, and we will be looking at them separately, both in the crude model and in the model incorporating these factors: (1) carrier, (2) month, (3) day of week, (4) distance of flight route, (5) time of day, and (6) region of departure.

```{r}
# crude, predictor: carrier
df <- dat %>%
   filter(DEP_DELAY_NEW>=15)
delay.lm = lm(DEP_DELAY_NEW ~ OP_UNIQUE_CARRIER, data = df)
lsmeans(delay.lm, ~ OP_UNIQUE_CARRIER)
```

```{r}
# adjusted, predictor: carrier
df <- df %>%
   mutate(hour_cat = cut(DEP_TIME, breaks=c(-Inf, 600, 1200, 1800, Inf), labels=c("0 to 6","6 to 12","12 to 18", "18 to 24"))) %>%
   mutate(NORTHEAST = ifelse(ORIGIN_STATE_ABR %in% c("CT","ME", "MA", "NH","RI","VT","NJ","NY","PA"), "yes", "no")) %>%
   mutate(MIDWEST = ifelse(ORIGIN_STATE_ABR %in% c("IL","IN","MI","OH","WI","IA","KS","MN","MO","NE","ND","SD"), "yes", "no")) %>%
   mutate(SOUTH = ifelse(ORIGIN_STATE_ABR %in% c("DE","FL","GA","MD","NC","SC","VA","DC","WV","AL","KY","MS","TN","AR","LA","OK","TX"), "yes", "no")) %>%
   mutate(WEST = ifelse(ORIGIN_STATE_ABR %in% c("AZ","CO","ID","MT","NV","NM","UT","WY","AK","CA","HI","OR","WA"), "yes", "no")) %>%
   mutate(SPRING = ifelse(MONTH %in% c(3,4,5),"yes","no")) %>%
   mutate(SUMMER = ifelse(MONTH %in% c(6,7,8),"yes","no")) %>%
   mutate(FALL = ifelse(MONTH %in% c(9,10,11),"yes","no")) %>%
   mutate(WINTER = ifelse(MONTH %in% c(12,1,2),"yes","no"))

delay2.lm = lm(DEP_DELAY_NEW ~ OP_UNIQUE_CARRIER + MONTH + factor(DAY_OF_WEEK) + DISTANCE + hour_cat + NORTHEAST + MIDWEST + SOUTH + WEST, data = df)

summary(delay2.lm)

lsmeans(delay2.lm, ~ OP_UNIQUE_CARRIER)
```

We summarized the above results into the table below:
![Table 1](C:/Users/jindanyao/Desktop/2018fall/2018fall/BST260/final project\bst260-airlinedelays-master\Table 1.PNG)

From the adjusted predicted mean delay times for each carrier, we see that when assuming all other factors are on average, `Hawaiian Airline` in general has the shortest predicted delay time, followed by Alaska Airline, American Airline and Delta Airline; and in general `JetBlue Airline` has the longest predicted delay times.

```{r}
# crude, predictor: day of week
delay_day.lm = lm(DEP_DELAY_NEW ~ factor(DAY_OF_WEEK), data = df)
lsmeans(delay_day.lm, ~ DAY_OF_WEEK)
```
```{r}
# adjusted, predictor: day of week
lsmeans(delay2.lm, ~ DAY_OF_WEEK )
```

We summarized the above results into the table below:
![Table 2](C:/Users/jindanyao/Desktop/2018fall/2018fall/BST260/final project\bst260-airlinedelays-master\Table 2.PNG)

From the adjusted predicted mean delay times by each day of week, we that that when assuming all other factors are on average, going on a flight on `Tuesday, Wednesday, or Saturday` would generally have shorter delay times, while leaving on `Friday` would probably lead to longer delay.
```{r}
# crude, predictor: time of day
delay_day.lm = lm(DEP_DELAY_NEW ~ factor(hour_cat), data = df)
lsmeans(delay_day.lm, ~ hour_cat)
```
```{r}
# adjusted, predictor: time of day
lsmeans(delay2.lm, ~ hour_cat )
```

We summarized the above results into the table below:
![Table 3](C:/Users/jindanyao/Desktop/2018fall/2018fall/BST260/final project\bst260-airlinedelays-master\Table 3.PNG)

From the adjusted model, we see that when assuming all other factors are on average, going on a flight at in the `morning (6:00 to 12:00)` would generally have shorter delay times, while leaving at `night (18:00 to 24:00)` would likely result in longer delay.

```{r}
# stratification
# predictor: carrier
# stratified by day of week
lsmeans(delay2.lm, ~ OP_UNIQUE_CARRIER*DAY_OF_WEEK )
```

We summarized the above results (stratified by day of week) into the table below:
![Table 4](C:/Users/jindanyao/Desktop/2018fall/2018fall/BST260/final project\bst260-airlinedelays-master\Table 4.PNG)
We see that similar to our previous findings, on average the delay times on `Tuesdays` are the shortest, and on Tuesday the carrier with the shortest predicted delay is `Hawaiian Airline`. Likewise, the predicted delay times for `Fridays` are the highest, and on Friday the carrier with the longest predicted delay is `JetBlue`. So probably not a good idea to leave on Friday on a JetBlue flight!

```{r}
# stratification
# predictor: carrier
# stratified by time of day
lsmeans(delay2.lm, ~ OP_UNIQUE_CARRIER*hour_cat )
```

We summarized the above results (stratified by time of day) into the table below:
![Table 5](C:/Users/jindanyao/Desktop/2018fall/2018fall/BST260/final project\bst260-airlinedelays-master\Table 5.PNG)
We see that similar to our previous findings, on average the delay times when leaving between `6:00 to 12:00` in the morning are the shortest, and at that time period the carrier with the shortest predicted delay is still `Hawaiian Airline`. Likewise, the predicted delay times for `18:00 to 24:00` are the highest, and at that time period the carrier with the longest predicted delay is still `JetBlue`. 


Since weather could impact delays, and weather patterns are often related to seasons, we also wish stratify by season to see if there are any differences:
```{r}
# stratification
# predictor: carrier
# stratified by season

# Spring
Spring <- df %>%
  filter (SPRING=="yes")

delay_spring.lm = lm(DEP_DELAY_NEW ~ OP_UNIQUE_CARRIER + MONTH + factor(DAY_OF_WEEK) + DISTANCE + hour_cat + NORTHEAST + MIDWEST + SOUTH + WEST, data = Spring)

summary(delay_spring.lm)

lsmeans(delay_spring.lm, ~ OP_UNIQUE_CARRIER )
```
```{r}
# Summer
Summer <- df %>%
  filter (SUMMER=="yes")

delay_summer.lm = lm(DEP_DELAY_NEW ~ OP_UNIQUE_CARRIER + MONTH + factor(DAY_OF_WEEK) + DISTANCE + hour_cat + NORTHEAST + MIDWEST + SOUTH + WEST, data = Summer)

summary(delay_summer.lm)

lsmeans(delay_summer.lm, ~ OP_UNIQUE_CARRIER )
```
```{r}
# Fall
Fall <- df %>%
  filter (FALL=="yes")

delay_fall.lm = lm(DEP_DELAY_NEW ~ OP_UNIQUE_CARRIER + MONTH + factor(DAY_OF_WEEK) + DISTANCE + hour_cat + NORTHEAST + MIDWEST + SOUTH + WEST, data = Fall)

summary(delay_fall.lm)

lsmeans(delay_fall.lm, ~ OP_UNIQUE_CARRIER )
```
```{r}
# release some memory
rm(Spring)
rm(Summer)
rm(Fall)
```


```{r}
# Winter
Winter <- df %>%
  filter (WINTER=="yes")

delay_winter.lm = lm(DEP_DELAY_NEW ~ OP_UNIQUE_CARRIER + MONTH + factor(DAY_OF_WEEK) + DISTANCE + hour_cat + NORTHEAST + MIDWEST + SOUTH + WEST, data = Winter)

summary(delay_winter.lm)

lsmeans(delay_winter.lm, ~ OP_UNIQUE_CARRIER )
```
```{r}
# release some memory
rm(delay.lm)
rm(delay_day.lm)
rm(delay_fall.lm)
rm(delay_hour.lm)
rm(delay_spring.lm)
rm(delay_summer.lm)
rm(delay_winter.lm)
rm(delay2.lm)
rm(Winter)
```

We summarized the above results (stratified by season) into the table below:
![Table 6](C:/Users/jindanyao/Desktop/2018fall/2018fall/BST260/final project\bst260-airlinedelays-master\Table 6.PNG)

We first see that in general, delays are much shorter during `Fall` for all carriers. Overall, Hawaiian Airline still show the shortest predicted delays for most seasons (except during Winter, where Alaska seems to be doing better). JetBlue has the longest delay time during Summer. In other seasons, some other carriers seem to have longer predicted delays than JetBlue.

# Predict delay probability for each carrier (stratified by season)

Since there might be extreme values in the delay times, we also wish to dichotimize delays into a binary variable (delaying 15+ minutes vs. delaying < 15 minutes or no delay) and see how these carriers perform, using logistic regression models:

```{r}
# predictor: carrier (adjusted)
# Spring
Spring <- df %>%
  filter (SPRING=="yes")

logit_model <- glm(DEP_DEL15 ~ OP_UNIQUE_CARRIER + MONTH + factor(DAY_OF_WEEK) + DISTANCE + hour_cat + NORTHEAST + MIDWEST + SOUTH + WEST, data=Spring, family = "binomial")
summary(logit_model)
exp(coef(logit_model))
```
```{r}
# predictor: carrier (adjusted)
# Summer
rm(Spring)
Summer <- df %>%
  filter (SUMMER=="yes")

logit_model <- glm(DEP_DEL15 ~ OP_UNIQUE_CARRIER + MONTH + factor(DAY_OF_WEEK) + DISTANCE + hour_cat + NORTHEAST + MIDWEST + SOUTH + WEST, data=Summer, family = "binomial")
summary(logit_model)
exp(coef(logit_model))
```
```{r}
# predictor: carrier (adjusted)
# Fall
rm(Summer)
Fall <- df %>%
  filter (FALL=="yes")

logit_model <- glm(DEP_DEL15 ~ OP_UNIQUE_CARRIER + MONTH + factor(DAY_OF_WEEK) + DISTANCE + hour_cat + NORTHEAST + MIDWEST + SOUTH + WEST, data=Fall, family = "binomial")
summary(logit_model)
exp(coef(logit_model))
```
```{r}
# predictor: carrier (adjusted)
# Winter
rm(Fall)
Winter <- df %>%
  filter (WINTER=="yes")

logit_model <- glm(DEP_DEL15 ~ OP_UNIQUE_CARRIER + MONTH + factor(DAY_OF_WEEK) + DISTANCE + hour_cat + NORTHEAST + MIDWEST + SOUTH + WEST, data=Winter, family = "binomial")
summary(logit_model)
exp(coef(logit_model))
```

We summarized the results (stratified by season) for logistic regressions into the table below:
![Table 7](C:/Users/jindanyao/Desktop/2018fall/2018fall/BST260/final project\bst260-airlinedelays-master\Table 7.PNG)

Similar to findings in the linear regressions results, here we also see that when compared to American Airline, the odds of delaying 15+ minutes for `Hawaiian Airline` is the lowest across all seasons, and the odds of delaying 15+ minutes is highest among either `JetBlue or Virgin America` (Depending on seasons).

